<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Wearly - Sign Up</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-DQvkBjpPgn7RC31MCQoOeC9TI2kdqa4+BSgNMNj8v77fdC77Kj5zpWFTJaaAoMbC"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <style>
      .navbar {
        display: flex;
        width: 90%;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        background-color: rgba(255, 255, 255, 0.9);
        border-bottom: 1px solid #dee2e6;
        padding: 10px 0;
      }
      .navbar .search {
        display: flex;
        min-width: 200px;
        max-width: 300px;
      }
      body {
        background-image: url('./photos/kids/a42892d4af7a7d3d7073f2e43cb15c9d.jpg');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        position: relative;
        min-height: 100vh;
      }
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        z-index: -1;
      }
      .card {
        background-color: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0);
      }
      .form-control.is-invalid {
        border-color: #dc3545;
      }
      .invalid-feedback {
        display: none;
      }
      .form-control.is-invalid ~ .invalid-feedback {
        display: block;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
      }
      .alert {
        max-width: 400px;
        margin: 1rem auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
          <div class="card shadow-sm my-5">
            <div class="card-body p-4">
              <h2 class="mb-4 text-center">Create Your Account</h2>
              <form id="signupForm" class="needs-validation" novalidate>
                <div class="mb-4">
                  <h5 class="mb-3">Basic Information</h5>
                  <div class="row g-3">
                    <div class="col-12">
                      <label for="name" class="form-label">Full Name*</label>
                      <input
                        type="text"
                        class="form-control"
                        id="name"
                        name="name"
                        autocomplete="name"
                        required
                        maxlength="100"
                        aria-describedby="nameHelp"
                      />
                      <div class="invalid-feedback">Please enter your full name (max 100 characters).</div>
                    </div>
                    <div class="col-12">
                      <label for="email" class="form-label">Email*</label>
                      <input
                        type="email"
                        class="form-control"
                        id="email"
                        name="email"
                        autocomplete="email"
                        required
                        maxlength="255"
                        aria-describedby="emailHelp"
                      />
                      <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                    <div class="col-12">
                      <label for="password" class="form-label">Password*</label>
                      <input
                        type="password"
                        class="form-control"
                        id="password"
                        name="password"
                        autocomplete="new-password"
                        required
                        minlength="6"
                        maxlength="100"
                        aria-describedby="passwordHelp"
                      />
                      <div id="passwordHelp" class="form-text">
                        Password must be 6-100 characters, including at least one uppercase letter, one lowercase letter, one digit, and one special character.
                      </div>
                      <div class="invalid-feedback" id="passwordFeedback">Password does not meet complexity requirements.</div>
                    </div>
                    <div class="col-12">
                      <label for="confirmPassword" class="form-label">Confirm Password*</label>
                      <input
                        type="password"
                        class="form-control"
                        id="confirmPassword"
                        name="confirmPassword"
                        autocomplete="new-password"
                        required
                        minlength="6"
                        maxlength="100"
                        aria-describedby="confirmPasswordHelp"
                      />
                      <div class="invalid-feedback">Passwords do not match.</div>
                    </div>
                    <div class="col-12">
                      <label for="phoneNo" class="form-label">Phone Number*</label>
                      <input
                        type="text"
                        class="form-control"
                        id="phoneNo"
                        name="phoneNo"
                        autocomplete="tel"
                        maxlength="11"
                        aria-describedby="phoneNoHelp"
                      />
                      <div id="phoneNoHelp" class="form-text">
                        Phone number must be exactly 11 digits (e.g., 01234567890).
                      </div>
                      <div class="invalid-feedback">Phone number must be exactly 11 digits.</div>
                    </div>
                  </div>
                </div>
                <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
                <button class="w-100 btn btn-primary btn-lg" type="submit" id="submitButton">
                  Create Account
                </button>
              </form>
              <div class="mt-3 text-center">
                <p>Already have an account? <a href="login.html">Log in</a></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.4/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YUe2LzesAfftltw+PEaao2tjU/QATaW/rOitAq67e0CT0Zi2VVRL0oC4+gAaeBKu"
      crossorigin="anonymous"
    ></script>
    <script>
      const BASE_URL = 'http://localhost:5107';
      (function () {
        'use strict';
        const form = document.getElementById('signupForm');
        const errorAlert = document.getElementById('errorAlert');
        const submitButton = document.getElementById('submitButton');
        const passwordRegex = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{6,100}$/;
        const phoneRegex = /^\d{11}$/;

        function showError(message) {
          errorAlert.classList.remove('d-none');
          errorAlert.classList.add('alert-danger');
          errorAlert.classList.remove('alert-success');
          errorAlert.textContent = message;
        }

        window.addEventListener('error', (event) => {
          if (event.message.includes('WebSocket')) {
            console.error('WebSocket Error:', event.message);
            showError('WebSocket connection failed. Please check your development server (e.g., Vite on port 3001).');
          }
        });

        form.addEventListener('submit', async function (event) {
          event.preventDefault();
          event.stopPropagation();
          form.classList.add('was-validated');
          errorAlert.classList.add('d-none');
          submitButton.disabled = true;

          const password = form.querySelector('#password');
          const passwordFeedback = form.querySelector('#passwordFeedback');
          if (!passwordRegex.test(password.value)) {
            password.classList.add('is-invalid');
            passwordFeedback.textContent = 'Password must include at least one uppercase letter, one lowercase letter, one digit, and one special character.';
            submitButton.disabled = false;
            return;
          } else {
            password.classList.remove('is-invalid');
            password.classList.add('is-valid');
          }

          const confirmPassword = form.querySelector('#confirmPassword');
          if (password.value !== confirmPassword.value) {
            confirmPassword.classList.add('is-invalid');
            submitButton.disabled = false;
            return;
          } else {
            confirmPassword.classList.remove('is-invalid');
            confirmPassword.classList.add('is-valid');
          }

          const phoneNo = form.querySelector('#phoneNo');
          if (phoneNo.value && !phoneRegex.test(phoneNo.value)) {
            phoneNo.classList.add('is-invalid');
            submitButton.disabled = false;
            return;
          } else if (phoneNo.value) {
            phoneNo.classList.remove('is-invalid');
            phoneNo.classList.add('is-valid');
          }

          if (form.checkValidity()) {
            try {
              const data = {
                name: form.querySelector('#name').value.trim(),
                email: form.querySelector('#email').value.trim(),
                password: password.value,
                phoneNo: phoneNo.value.trim() || null
              };

              const response = await fetch(`${BASE_URL}/api/v1/accounts/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                credentials: 'include'
              });

              const result = await response.json();

              if (response.ok) {
                errorAlert.classList.remove('alert-danger', 'd-none');
                errorAlert.classList.add('alert-success');
                errorAlert.textContent = result.message || 'Registration successful!';
                setTimeout(() => {
                  window.location.href = './index.html'; // Redirect to profile
                }, 2000);
              } else {
                showError(result.message || 'An error occurred.');
                if (result.errors) {
                  showError(`${result.message} ${result.errors.join(', ')}`);
                }
              }
            } catch (error) {
              console.error('Sign-up error:', error);
              showError('Failed to connect to the server. Please check your connection or backend server (port 5107).');
            }
          }

          submitButton.disabled = false;
        });

        form.querySelector('#confirmPassword').addEventListener('input', function () {
          if (this.value !== form.querySelector('#password').value) {
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });

        form.querySelector('#phoneNo').addEventListener('input', function () {
          if (this.value && !phoneRegex.test(this.value)) {
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });
      })();
    </script>
  </body>
</html>